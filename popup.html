<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Follow-Up Scheduler</title>
  <style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 20px;
}

.card {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  padding: 20px;
  max-width: 380px;
  margin: auto;
  text-align: center;
}

h2 {
  color: #0078d4;
  margin-top: 0;
}

#question {
  font-size: 15px;
  color: #333;
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 12px;
  text-align: left;
}

label {
  display: block;
  font-weight: 500;
  color: #555;
  margin-bottom: 5px;
}

input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}

button {
  background: #0078d4;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}

button:hover {
  background: #005a9e;
}

#status {
  margin-top: 12px;
  font-size: 14px;
  color: #333;
}
  </style>

  <script>
   Office.onReady(async () => {
      try {
        const item = Office.context.mailbox.item;
        const subject = item.subject || "(No Subject)";
        let recipients = [];

        if (item.to && item.to.length > 0) {
          recipients = item.to.map(r => r.displayName || r.emailAddress);
        } else if (item.displayTo) {
          recipients = item.displayTo.split(";").map(s => s.trim());
        }

        document.getElementById("recipient").textContent = recipients.join(", ");
        document.getElementById("subject").textContent = subject;

        const hasFollowUpCategory = await checkForCategory("FollowUpPrompt");

        if (!hasFollowUpCategory) return;

        document.querySelector(".card").style.display = "block";

        document.getElementById("scheduleBtn").addEventListener("click", async () => {
          const date = document.getElementById("dateInput").value;
          const time = document.getElementById("timeInput").value;
          const manual = document.getElementById("manualInput")?.value?.trim();

          const datetimeInput = manual || (date && time ? `${date}T${time}` : null);
          if (!datetimeInput) {
            document.getElementById("status").textContent = "Please enter a valid date/time.";
            return;
          }

          try {
            const start = new Date(datetimeInput);
            const end = new Date(start.getTime() + 30 * 60000);
            const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });

            const response = await fetch("https://graph.microsoft.com/v1.0/me/events", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                subject: `Follow up with ${recipients.join(", ")} about ${subject}`,
                start: {
                  dateTime: start.toISOString(),
                  timeZone: "UTC"
                },
                end: {
                  dateTime: end.toISOString(),
                  timeZone: "UTC"
                },
                body: {
                  contentType: "HTML",
                  content: "This is a scheduled follow-up reminder."
                }
              })
            });

            document.getElementById("status").textContent = response.ok
              ? "Reminder scheduled successfully! âœ…"
              : "Failed to create event.";
          } catch (err) {
            console.error(err);
            document.getElementById("status").textContent = "Error connecting to Microsoft Graph.";
          }
        });
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "Error initializing add-in.";
      }
    });

    async function checkForCategory(categoryName) {
      try {
        const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });
        const encodedId = encodeURIComponent(Office.context.mailbox.item.itemId);
        const url = `https://graph.microsoft.com/v1.0/me/messages/${encodedId}?$select=categories`;

        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) return false;
        const json = await res.json();
        return Array.isArray(json.categories) && json.categories.includes(categoryName);
      } catch (err) {
        console.error("Error checking categories:", err);
        return false;
      }
    }
  </script>

</head>
<body>
  <div class="card">
    <h2>Follow-Up Reminder</h2>
    <p id="question">Would you like to schedule a reminder to follow up with <span id="recipient"></span> about <span id="subject"></span>?</p>

    <div class="input-group">
      <label for="dateInput">Select Date:</label>
      <input type="date" id="dateInput" />
    </div>

    <div class="input-group">
      <label for="timeInput">Select Time:</label>
      <input type="time" id="timeInput" />
    </div>

    <button id="scheduleBtn">Schedule Reminder</button>
    <p id="status"></p>
  </div>
</body>
</html>
